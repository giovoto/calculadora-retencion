<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de Retenci√≥n - Colombia 2025</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f0f2f5, #dbe2ef);
      padding: 40px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .flex-container {
      display: flex;
      gap: 30px;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
      max-width: 900px;
      width: 100%;
    }
    .container {
      background-color: #ffffff;
      border-radius: 12px;
      padding: 30px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #333;
    }
    label {
      font-weight: 600;
      margin-top: 15px;
      display: block;
      color: #444;
    }
    select, input[type="number"], input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      background: #f4f7fa;
      transition: border 0.2s;
    }
    select:focus, input:focus {
      border: 1.5px solid #007bff;
      outline: none;
      background: #eaf2fc;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    .checkbox-label input {
      width: auto;
      margin-right: 10px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px;
      font-size: 16px;
      width: 100%;
      border-radius: 8px;
      margin-top: 25px;
      cursor: pointer;
      transition: background-color 0.3s, box-shadow 0.3s;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      letter-spacing: 0.02em;
    }
    button:hover {
      background-color: #0056b3;
      box-shadow: 0 4px 14px rgba(0,123,255,0.12);
    }
    #btn-limpiar {
      background-color: #6c757d !important;
      margin-top: 10px !important;
    }
    #btn-limpiar:hover {
      background-color: #495057 !important;
    }
    #resultado {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      border-left: 6px solid #007bff;
      min-width: 320px;
      max-width: 350px;
      margin-top: 0;
      height: fit-content;
      display: none;
      box-shadow: 0 5px 18px rgba(0,123,255,0.06);
    }
    #resultado p {
      margin: 8px 0;
      font-size: 15px;
      word-wrap: break-word;
    }
    .valor-grande {
      font-size: 22px;
      font-weight: bold;
      color: #000;
      margin-top: 20px;
    }
    .valor-suave {
      color: #888;
    }
    #ica-container {
      display: none;
    }
    #declarante-container {
      display: none;
    }
  </style>
</head>
<body>
  <div class="flex-container">
    <div class="container">
      <h2>Calculadora de Retenci√≥n 2025</h2>
      <form id="calc-form">
        <label for="quienCompra">¬øQui√©n compra?</label>
        <select id="quienCompra" required>
          <option value="persona_juridica">Persona Jur√≠dica</option>
          <option value="persona_natural">Persona Natural</option>
        </select>

        <label for="quienVende">¬øQui√©n vende?</label>
        <select id="quienVende" required>
          <option value="persona_juridica">Persona Jur√≠dica</option>
          <option value="persona_natural">Persona Natural</option>
        </select>

        <div class="checkbox-label" id="declarante-container">
          <input type="checkbox" id="esNoDeclarante" />
          <label for="esNoDeclarante">¬øLa persona natural no es declarante del impuesto de renta?</label>
        </div>

        <label for="razonSocial">Raz√≥n Social (opcional):</label>
        <input type="text" id="razonSocial" placeholder="Ej: Constructora XYZ S.A.S" />

        <label for="responsabilidades">Responsabilidades fiscales:</label>
        <select id="responsabilidades" multiple size="6" required></select>

        <label for="valor">Valor de la operaci√≥n (sin IVA):</label>
        <input type="number" id="valor" min="0" step="0.01" required />

        <label for="conceptoOperacion">Concepto de la operaci√≥n:</label>
        <select id="conceptoOperacion" required>
          <option value="">Seleccione un concepto</option>

          <optgroup label="üõí Compras">
            <option value="compras_generales">Compras generales</option>
            <option value="compras_agricolas">Compras agr√≠colas sin procesamiento industrial</option>
          </optgroup>

          <optgroup label="üîß Servicios">
            <option value="servicios_generales">Servicios generales</option>
          </optgroup>

          <optgroup label="üè¢ Arrendamientos">
            <option value="arrendamiento_inmuebles">Arrendamiento de inmuebles</option>
          </optgroup>

          <optgroup label="üíº Honorarios y Comisiones">
            <option value="honorarios_juridica">Honorarios (persona jur√≠dica)</option>
            <option value="honorarios_natural">Honorarios (persona natural)</option>
          </optgroup>

          <optgroup label="üöõ Transporte">
            <option value="transporte_carga">Transporte de carga</option>
          </optgroup>

          <optgroup label="üè¶ Financieros">
            <option value="intereses_financieros">Intereses o rendimientos financieros</option>
          </optgroup>
        </select>

        <label>Tarifa de IVA:</label>
        <div id="iva-options">
          <label class="checkbox-label"><input type="checkbox" name="iva" value="0.05" /> IVA 5%</label>
          <label class="checkbox-label"><input type="checkbox" name="iva" value="0.19" /> IVA 19%</label>
          <label class="checkbox-label"><input type="checkbox" name="iva" value="0" data-etiqueta="exento" /> Exento</label>
          <label class="checkbox-label"><input type="checkbox" name="iva" value="0" data-etiqueta="excluido" /> Excluido</label>
        </div>

        <div class="checkbox-label">
          <input type="checkbox" id="esBogota" />
          <label for="esBogota">¬øLa operaci√≥n se realiza en Bogot√°?</label>
        </div>

        <div id="ica-container">
          <label for="tarifaICA">Tarifa ICA Bogot√° (‚Ä∞):</label>
          <select id="tarifaICA">
            <option value="">Seleccione una tarifa</option>
            <option value="4.14">4.14 ‚Ä∞</option>
            <option value="6.9">6.9 ‚Ä∞</option>
            <option value="8">8.0 ‚Ä∞</option>
            <option value="11.04">11.04 ‚Ä∞</option>
          </select>
        </div>

        <button type="submit">Calcular</button>
        <button type="button" id="btn-limpiar">Limpiar</button>
      </form>
    </div>
    <div id="resultado"></div>
  </div>

  <script>
    const tablaRetencion = {
      compras_generales: {
        declarante: { base: 498000, tarifa: 0.025 },
        no_declarante: { base: 498000, tarifa: 0.035 }
      },
      servicios_generales: {
        declarante: { base: 100000, tarifa: 0.04 },
        no_declarante: { base: 100000, tarifa: 0.06 }
      },
      arrendamiento_inmuebles: {
        declarante: { base: 498000, tarifa: 0.035 },
        no_declarante: { base: 498000, tarifa: 0.035 }
      },
      honorarios_juridica: { base: 0, tarifa: 0.11 },
      honorarios_natural: {
        declarante: { base: 0, tarifa: 0.11 },
        no_declarante: { base: 0, tarifa: 0.10 }
      },
      compras_agricolas: { base: 3486000, tarifa: 0.015 },
      transporte_carga: { base: 100000, tarifa: 0.01 },
      intereses_financieros: { base: 0, tarifa: 0.07 }
    };

    const conceptosConDeclarantes = ['compras_generales', 'servicios_generales', 'honorarios_natural', 'arrendamiento_inmuebles'];

    const quienVendeSelect = document.getElementById('quienVende');
    const responsabilidadesSelect = document.getElementById('responsabilidades');
    const declaranteContainer = document.getElementById('declarante-container');
    const declaranteCheckbox = document.getElementById('esNoDeclarante');
    const conceptoOperacion = document.getElementById('conceptoOperacion');

    conceptoOperacion.addEventListener('change', () => {
      const concepto = conceptoOperacion.value;
      if (conceptosConDeclarantes.includes(concepto)) {
        declaranteContainer.style.display = 'flex';
      } else {
        declaranteCheckbox.checked = false;
        declaranteContainer.style.display = 'none';
      }
    });

    document.getElementById('calc-form').addEventListener('submit', function (e) {
      e.preventDefault();

      const valorBase = parseFloat(document.getElementById('valor').value);
      const tarifaIVASeleccionada = document.querySelector('#iva-options input[type="checkbox"]:checked');
      const tarifaIVA = tarifaIVASeleccionada ? parseFloat(tarifaIVASeleccionada.value) : 0;
      const valorIVA = valorBase * tarifaIVA;
      const valorTotalConIVA = valorBase + valorIVA;

      const esBogota = document.getElementById('esBogota').checked;
      const tarifaICA = parseFloat(document.getElementById('tarifaICA').value) || 0;
      const responsabilidadesSeleccionadas = Array.from(responsabilidadesSelect.selectedOptions).map(opt => opt.value);
      const razonSocial = document.getElementById('razonSocial').value.trim();
      const esNoDeclarante = declaranteCheckbox.checked;
      const concepto = conceptoOperacion.value;

      if (!concepto || !tablaRetencion[concepto]) {
        alert('Debe seleccionar un concepto v√°lido de operaci√≥n.');
        return;
      }

      if (responsabilidadesSeleccionadas.length === 0) {
        alert('Debe seleccionar al menos una responsabilidad fiscal.');
        return;
      }

      let reteIVA = 0;
      if (tarifaIVA > 0 && responsabilidadesSeleccionadas.includes('O-23')) {
        reteIVA = valorIVA * 0.15;
      }

      let retefuente = 0;
      let tarifaAplicada = 0;
      const datosRetencion = tablaRetencion[concepto];
      if (!responsabilidadesSeleccionadas.includes('O-15')) {
        if (datosRetencion?.tarifa) {
          // Tarifa √∫nica
          if (valorBase >= datosRetencion.base) {
            retefuente = valorBase * datosRetencion.tarifa;
            tarifaAplicada = datosRetencion.tarifa;
          }
        } else {
          // Tiene declarante/no_declarante
          const tipo = esNoDeclarante ? 'no_declarante' : 'declarante';
          const datos = datosRetencion[tipo];
          if (datos && valorBase >= datos.base) {
            retefuente = valorBase * datos.tarifa;
            tarifaAplicada = datos.tarifa;
          }
        }
      }

      let ica = esBogota ? valorBase * (tarifaICA / 1000) : 0;
      const totalRetenciones = retefuente + reteIVA + ica;
      const valorNeto = valorTotalConIVA - totalRetenciones;

      document.getElementById('resultado').innerHTML = `
        ${razonSocial ? `<p><strong>Raz√≥n Social:</strong> ${razonSocial}</p>` : ''}
        <p class="valor-suave"><strong>Valor base:</strong> $${valorBase.toLocaleString('es-CO', {minimumFractionDigits: 2})}</p>
        <p class="valor-suave"><strong>IVA (${(tarifaIVA * 100).toFixed(0)}%):</strong> $${valorIVA.toLocaleString('es-CO', {minimumFractionDigits: 2})}</p>
        <p class="valor-suave"><strong>Retefuente (${(tarifaAplicada * 100).toFixed(1)}%):</strong> $${retefuente.toLocaleString('es-CO', {minimumFractionDigits: 2})}</p>
        <p class="valor-suave"><strong>ReteIVA (15% sobre IVA):</strong> $${reteIVA.toLocaleString('es-CO', {minimumFractionDigits: 2})}</p>
        <p class="valor-suave"><strong>ICA Bogot√° (${tarifaICA.toFixed(2)}‚Ä∞):</strong> $${ica.toLocaleString('es-CO', {minimumFractionDigits: 2})}</p>
        <p class="valor-grande">Total Retenciones: $${Math.round(totalRetenciones).toLocaleString('es-CO')}</p>
        <p class="valor-grande">Valor neto a pagar: $${Math.round(valorNeto).toLocaleString('es-CO')}</p>
      `;
      document.getElementById('resultado').style.display = 'block';
    });

    document.getElementById('btn-limpiar').addEventListener('click', () => {
      document.getElementById('calc-form').reset();
      document.getElementById('resultado').style.display = 'none';
      declaranteContainer.style.display = 'none';
      localStorage.clear();
    });

    // Cargar responsabilidades seg√∫n tipo
    const cargarResponsabilidades = tipoPersona => {
      responsabilidadesSelect.innerHTML = '';
      const responsabilidades = {
        persona_juridica: [
          { value: 'O-13', label: 'O-13 - Gran Contribuyente' },
          { value: 'O-15', label: 'O-15 - Autorretenedor' },
          { value: 'O-23', label: 'O-23 - Agente de Retenci√≥n IVA' },
          { value: 'O-47', label: 'O-47 - R√©gimen Simple' },
          { value: 'R-99-PN', label: 'R-99-PN - No responsable' },
          { value: 'NINGUNA', label: 'No aplica / Sin responsabilidad' },
        ],
        persona_natural: [
          { value: 'O-47', label: 'O-47 - R√©gimen Simple' },
          { value: 'R-99-PN', label: 'R-99-PN - No responsable' },
          { value: 'NINGUNA', label: 'No aplica / Sin responsabilidad' },
        ],
      };

      (responsabilidades[tipoPersona] || []).forEach(opcion => {
        const opt = document.createElement('option');
        opt.value = opcion.value;
        opt.textContent = opcion.label;
        responsabilidadesSelect.appendChild(opt);
      });
    };

    quienVendeSelect.addEventListener('change', () => {
      cargarResponsabilidades(quienVendeSelect.value);
    });

    document.addEventListener('DOMContentLoaded', () => {
      cargarResponsabilidades(quienVendeSelect.value);
    });
  </script>
</body>
</html>
